name: Policy checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body has issue-closing reference
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const ok = /(Closes|Close|Fixes|Fix|Resolves|Resolve)\s+#\d+/i.test(body);
            if (!ok) {
              core.setFailed("PR description must include e.g. 'Closes #123' (or Fixes/Resolves).");
            }

      - name: Check commit messages follow Conventional Commits
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner, repo, pull_number, per_page: 100
            });

            const re = /^(feat|fix|docs|refactor|test|chore)(\([^)]+\))?: .+/;
            const bad = commits
              .map(c => c.commit.message.split('\n')[0])
              .filter(msg => !re.test(msg));

            if (bad.length) {
              core.setFailed(
                "These commits are not Conventional Commits (expected type(scope): message):\n" +
                bad.map(m => `- ${m}`).join("\n")
              );
            }
